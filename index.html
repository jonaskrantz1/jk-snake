<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Jonas Snakespel</title>
  <link rel="stylesheet" href="https://pyscript.net/releases/2025.3.1/core.css" />
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <link rel="icon" href="favicon.png" type="image/png">
  <script type="module" src="https://pyscript.net/releases/2025.3.1/core.js"></script>
  <style>
    body { background-color: #000; color: white; font-family: 'Press Start 2P', Arial, sans-serif; margin: 0; padding: 0; text-align: center; }
    canvas { background-color: #222; border: 1px solid white; margin-top: 20px; width: 100%; max-width: 600px; height: auto; }
    #startScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; }
    #startButton { font-size: 24px; padding: 10px 20px; margin-bottom: 20px; }
    #topList { font-size: 18px; margin-top: 10px; text-align: left; }
    @media (hover: hover) { #touchControls { display: none; } }
  </style>
</head>
<body>
  <h1>Jonas snakespel</h1>
  <div id="startScreen">
    <button id="startButton" onclick="startWithMusic()">Klicka för att starta spelet</button>
    <div id="topList">Hämtar global highscore…</div>
  </div>
  <canvas id="gameCanvas" width="600" height="400"></canvas>
  <audio id="soundFood" src="pling.wav"></audio>
  <audio id="soundDeath" src="death.wav"></audio>
  <audio id="bgMusic" src="music.mp3" loop></audio>
  <audio id="rainbowLoop" src="rainbow-food.wav" loop></audio>
  <audio id="soundRainbowEat" src="pling.wav"></audio>

  <py-script>
import asyncio, random, time
from js import document
from pyodide.ffi import create_proxy

WIDTH, HEIGHT, CELL = 600, 400, 20
canvas = document.getElementById("gameCanvas")
ctx = canvas.getContext("2d")

game_state = "waiting"
player_snake = [(WIDTH//2, HEIGHT//2)]
player_length = 5
player_score = 0

enemy_snake = [(300, 200)]
enemy_length = 1

direction = (CELL, 0)
pending_direction = direction
foods = []
level = 1
counter = 0
time_left = 20.0
speed_delay = 0.1
speed_multiplier = 0.85
rainbow_exists = False

def occupied(x, y): return (x, y) in player_snake or (x, y) in enemy_snake

def spawn_food(kind):
    while True:
        x = random.randrange(0, WIDTH, CELL)
        y = random.randrange(0, HEIGHT, CELL)
        if not occupied(x, y):
            foods.append((x, y, kind))
            break

def update_snake():
    global direction, pending_direction, player_length, player_score, rainbow_exists
    if (pending_direction[0], pending_direction[1]) != (-direction[0], -direction[1]):
        direction = pending_direction
    head_x, head_y = player_snake[0]
    new = ((head_x+direction[0])%WIDTH, (head_y+direction[1])%HEIGHT)
    if new in player_snake or new in enemy_snake:
        asyncio.ensure_future(game_over())
        return
    player_snake.insert(0, new)
    for f in foods[:]:
        if (f[0], f[1]) == new:
            if f[2] == "rainbow":
                player_length = 5
                player_snake[:] = player_snake[:player_length]
                try: document.getElementById("soundRainbowEat").play()
                except: pass
                try: loop = document.getElementById("rainbowLoop"); loop.pause(); loop.currentTime = 0
                except: pass
                rainbow_exists = False
            else:
                player_length += 1
                player_score += 10 if f[2] == "red" else 30
                try: document.getElementById("soundFood").play()
                except: pass
                spawn_food(f[2])
            foods.remove(f)
            break
    if len(player_snake) > player_length:
        player_snake.pop()

def update_enemy():
    global enemy_snake, enemy_length, rainbow_exists
    head = enemy_snake[0]
    dirs = [(CELL,0), (-CELL,0), (0,CELL), (0,-CELL)]
    random.shuffle(dirs)
    for dx, dy in dirs:
        new = ((head[0]+dx)%WIDTH, (head[1]+dy)%HEIGHT)
        if new not in enemy_snake and new not in player_snake:
            break
    else:
        new = ((head[0]+CELL)%WIDTH, head[1])
    if new in enemy_snake or new in player_snake:
        enemy_snake[:] = [(300,200)]
        enemy_length = 1
        rainbow_exists = False
        return
    enemy_snake.insert(0, new)
    for f in foods[:]:
        if (f[0], f[1]) == new:
            if f[2] == "rainbow":
                enemy_length = max(1, enemy_length // 2)
                enemy_snake[:] = enemy_snake[:enemy_length]
                try: document.getElementById("soundRainbowEat").play()
                except: pass
                try: loop = document.getElementById("rainbowLoop"); loop.pause(); loop.currentTime = 0
                except: pass
                rainbow_exists = False
            else:
                enemy_length += 1
                spawn_food(f[2])
            foods.remove(f)
            break
    if len(enemy_snake) > enemy_length:
        enemy_snake.pop()

def draw():
    ctx.fillStyle = "black"
    ctx.fillRect(0, 0, WIDTH, HEIGHT)
    for x, y in player_snake:
        ctx.fillStyle = "lime"
        ctx.fillRect(x, y, CELL, CELL)
    for x, y in enemy_snake:
        ctx.fillStyle = "blue"
        ctx.fillRect(x, y, CELL, CELL)
    for x, y, k in foods:
        ctx.fillStyle = "hsl(%d,100%%,50%%)" % int((time.time()*200)%360) if k == "rainbow" else ("gold" if k == "yellow" else "red")
        ctx.fillRect(x, y, CELL, CELL)
    ctx.fillStyle = "white"
    ctx.font = "16px Arial"
    ctx.fillText(f"Poäng: {player_score}", 10, 20)
    ctx.fillText(f"Tid: {int(time_left)}", WIDTH-100, 20)
    ctx.fillText(f"Masklängd: {player_length}", 10, 40)
    ctx.fillText(f"Hastighet: {round(1/speed_delay,1)}", 10, 60)
    ctx.fillText(f"Level: {level}", 10, 80)

def stop_music():
    try: document.getElementById("bgMusic").pause()
    except: pass

async def game_over():
    global game_state
    stop_music()
    try: document.getElementById("soundDeath").play()
    except: pass
    try: document.getElementById("rainbowLoop").pause(); document.getElementById("rainbowLoop").currentTime = 0
    except: pass
    game_state = "gameover"
    document.getElementById("startScreen").style.display = "flex"

async def game_loop():
    global counter, time_left, speed_delay, level, rainbow_exists
    while True:
        if game_state == "playing":
            time_left -= speed_delay
            if time_left <= 0:
                speed_delay *= speed_multiplier
                time_left = 20.0
                level += 1
                if level % 3 == 0 and not rainbow_exists:
                    spawn_food("rainbow")
                    rainbow_exists = True
                    try: document.getElementById("rainbowLoop").play()
                    except: pass
            update_snake()
            if counter % 2 == 0:
                update_enemy()
            if not any(f[2] == "yellow" for f in foods) and random.random() < 0.01:
                spawn_food("yellow")
            draw()
            counter += 1
        await asyncio.sleep(speed_delay)

def start_game(evt=None):
    global game_state, counter, player_score, player_length, enemy_length, direction, pending_direction, level, time_left, speed_delay
    game_state = "playing"
    counter = 0
    player_snake[:] = [(WIDTH//2, HEIGHT//2)]
    player_length = 5; player_score = 0
    enemy_snake[:] = [(300, 200)]
    enemy_length = 1
    direction = (CELL, 0)
    pending_direction = direction
    foods.clear(); spawn_food("red"); spawn_food("red")
    level = 1; time_left = 20.0; speed_delay = 0.1
    document.getElementById("startScreen").style.display = "none"
    try: document.getElementById("bgMusic").play()
    except: pass
    for id in ("soundFood","soundDeath"): el = document.getElementById(id); el.load() if el else None

asyncio.ensure_future(game_loop())
  </py-script>

  <script>
  async function startWithMusic(){ let m=document.getElementById("bgMusic"); if(m&&m.paused) try{await m.play()}catch(e){}
    document.dispatchEvent(new Event("startGame")); }
  </script>
</body>
</html>
