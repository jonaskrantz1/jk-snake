<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Jonas Snakespel</title>
  <link rel="stylesheet" href="https://pyscript.net/releases/2025.3.1/core.css" />
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <script type="module" src="https://pyscript.net/releases/2025.3.1/core.js"></script>
  <style>
    body {
      background-color: #000;
      text-align: center;
      color: white;
      font-family: 'Press Start 2P', Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    canvas {
      background-color: #222;
      border: 1px solid white;
      margin-top: 20px;
      width: 100%;
      max-width: 600px;
      height: auto;
    }
    #startScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    #startButton {
      font-size: 24px;
      padding: 10px 20px;
      margin-bottom: 20px;
    }
    #topList {
      font-size: 18px;
      margin-top: 10px;
    }
    #touchControls {
      margin-top: 20px;
    }
    #touchControls button {
      font-size: 32px;
      padding: 10px 20px;
      margin: 5px;
    }
    /* D√∂lj touchkontroller p√• enheter med mus */
    @media (hover: hover) {
      #touchControls {
        display: none;
      }
    }
  </style>
</head>
<body>
  <h1>Snake med Global Highscore</h1>
  <div id="startScreen">
    <button id="startButton" onclick="startWithMusic()">Klicka f√∂r att starta spelet</button>
    <div id="topList">H√§mtar global highscore...</div>
  </div>

  <canvas id="gameCanvas" width="600" height="400"></canvas>

  <div id="touchControls">
    <button id="btnUp">‚¨ÜÔ∏è</button><br>
    <button id="btnLeft">‚¨ÖÔ∏è</button>
    <button id="btnDown">‚¨áÔ∏è</button>
    <button id="btnRight">‚û°Ô∏è</button>
  </div>

  <audio id="soundFood" src="pling.wav"></audio>
  <audio id="soundDeath" src="death.wav"></audio>
  <audio id="bgMusic" src="music.mp3" loop></audio>

  <py-script>
import asyncio, random, time, json
from js import document, window, fetch
from pyodide.ffi import create_proxy
from pyodide.ffi import to_js  # Se till att detta √§r importerat i b√∂rjan

# Globala spelvariabler
WIDTH, HEIGHT, CELL = 600, 400, 20
canvas = document.getElementById("gameCanvas")
ctx = canvas.getContext("2d")
game_state = "waiting"
game_loop_running = False
player_snake = [(WIDTH // 2, HEIGHT // 2)]
player_length = 5
player_score = 0
enemy_snake = [(300, 200)]
enemy_length = 1
start_time = time.time()
foods = [(random.randrange(0, WIDTH, CELL), random.randrange(0, HEIGHT, CELL), "red") for _ in range(2)]
direction = (CELL, 0)
highscores = []
counter = 0

#Mobilstyrning
def touch_direction(dir):
    global direction
    if game_state != "playing":
        return
    if dir == "up" and direction[1] == 0:
        direction = (0, -CELL)
    elif dir == "down" and direction[1] == 0:
        direction = (0, CELL)
    elif dir == "left" and direction[0] == 0:
        direction = (-CELL, 0)
    elif dir == "right" and direction[0] == 0:
        direction = (CELL, 0)

# Bind touch-knappar till styrning
from js import document
from pyodide.ffi import create_proxy
document.getElementById("btnUp").addEventListener("click", create_proxy(lambda e: touch_direction("up")))
document.getElementById("btnDown").addEventListener("click", create_proxy(lambda e: touch_direction("down")))
document.getElementById("btnLeft").addEventListener("click", create_proxy(lambda e: touch_direction("left")))
document.getElementById("btnRight").addEventListener("click", create_proxy(lambda e: touch_direction("right")))


# Highscore API
async def submit_highscore(name, score):
    url = "https://highscore.jonas-krantz-1.workers.dev/highscores"
    payload = json.dumps({"name": name, "score": score})

    print("üîÑ F√∂rs√∂ker POSTa highscore till Cloudflare...")
    print("Payload:", payload)

    response = await fetch(url, to_js({
        "method": "POST",
        "headers": {"Content-Type": "application/json"},
        "body": payload
    }))

    print("üì¨ Svar fr√•n servern:", response.status)

    result = await response.json()
    return result.to_py()

async def get_highscores():
    url = "https://highscore.jonas-krantz-1.workers.dev/highscores"
    response = await fetch(url)
    result = await response.json()
    return result.to_py()

async def check_highscore():
    global highscores, player_score

    # 1. H√§mta aktuell lista
    try:
        hs = await get_highscores()
    except Exception as e:
        print("‚ö†Ô∏è Misslyckades h√§mta highscore:", e)
        return

    # 2. Kolla om po√§ngen platsar (mindre √§n 10 poster, eller h√∂gre √§n l√§gsta)
    qualifies = len(hs) < 10 or player_score > min(entry["score"] for entry in hs)

    if not qualifies:
        print("‚ÑπÔ∏è Po√§ngen kvalar inte in:", player_score)
        highscores = hs
        return

    # 3. Visa prompt och spara
    name = window.prompt("NY HIGH SCORE! Namn:")
    if not name:
        name = "Anon"

    print("üîº Skickar till Worker:", name, player_score)
    highscores = await submit_highscore(name, player_score)
    print("‚úÖ Svar fr√•n Worker:", highscores)
    await update_start_toplist()



def stop_music():
    try:
        document.getElementById("bgMusic").pause()
    except:
        pass

async def game_over():
    global game_state, game_loop_running
    game_loop_running = False
    stop_music()
    try:
        document.getElementById("soundDeath").play()
    except:
        pass
    game_state = "gameover"
    await asyncio.sleep(0.1)
    await check_highscore()
    document.getElementById("startScreen").style.display = "flex"


async def game_loop():
    global counter, game_state, game_loop_running
    if game_loop_running:
        return
    game_loop_running = True
    while True:
        if game_state == "playing":
            ctx.fillStyle = "black"
            ctx.fillRect(0, 0, WIDTH, HEIGHT)
            update_snake()
            draw_snake()
            draw_food()
            draw_enemy()
            draw_ui()
            if counter % 2 == 0:
                update_enemy()
            if not any(f[2] == "yellow" for f in foods) and random.random() < 0.01:
                foods.append((random.randrange(0, WIDTH, CELL), random.randrange(0, HEIGHT, CELL), "yellow"))
            counter += 1
        elif game_state == "gameover":
            draw_game_over()
        await asyncio.sleep(0.1)

def draw_game_over():
    ctx.fillStyle = "black"
    ctx.fillRect(0, 0, WIDTH, HEIGHT)  # üßπ Rensar hela canvasen f√∂rst
    ctx.fillStyle = "red"
    ctx.font = "16px 'Press Start 2P'"
    ctx.fillText("GAME OVER", WIDTH // 2 - 120, HEIGHT // 2 - 40)

    ctx.fillStyle = "white"
    ctx.font = "12px 'Press Start 2P'"
    ctx.fillText(f"Po√§ng: {player_score}", WIDTH // 2 - 80, HEIGHT // 2)
    ctx.fillText("Tryck p√• start", WIDTH // 2 - 100, HEIGHT // 2 + 40)
    ctx.fillText("f√∂r att spela igen", WIDTH // 2 - 130, HEIGHT // 2 + 60)

    draw_ui()
    document.getElementById("startScreen").style.display = "flex"



def draw_snake():
    for x, y in player_snake:
        ctx.fillStyle = "lime"
        ctx.fillRect(x, y, CELL, CELL)

def draw_food():
    for x, y, kind in foods:
        ctx.fillStyle = "gold" if kind == "yellow" else "red"
        ctx.fillRect(x, y, CELL, CELL)

def draw_enemy():
    for x, y in enemy_snake:
        ctx.fillStyle = "blue"
        ctx.fillRect(x, y, CELL, CELL)

def draw_ui():
    ctx.fillStyle = "white"
    ctx.font = "16px Arial"
    ctx.fillText(f"Po√§ng: {player_score}", 10, 20)
    if game_state == "gameover":
        y = 100
        ctx.fillText("Topplista:", 10, y)
        for entry in highscores:
            y += 20
            ctx.fillText(f"{entry['name']}: {entry['score']}", 10, y)

def update_snake():
    global player_snake, player_score, player_length
    head_x, head_y = player_snake[0]
    dx, dy = direction
    new_head = ((head_x + dx) % WIDTH, (head_y + dy) % HEIGHT)
    if new_head in player_snake or new_head in enemy_snake:
        try:
            document.getElementById("soundDeath").play()
        except:
            pass
        asyncio.ensure_future(game_over())
        return

    player_snake.insert(0, new_head)
    for f in foods[:]:
        if (f[0], f[1]) == new_head:
            player_length += 1
            player_score += 10 if f[2] == "red" else 30
            try:
                document.getElementById("soundFood").play()
            except:
                pass
            foods.remove(f)
            if f[2] == "red":
                foods.append((random.randrange(0, WIDTH, CELL), random.randrange(0, HEIGHT, CELL), "red"))
            return
    if len(player_snake) > player_length:
        player_snake.pop()

def update_enemy():
    global enemy_snake, enemy_length, game_state
    head = enemy_snake[0]

    dx, dy = get_valid_enemy_move(head)
    new_head = ((head[0] + dx) % WIDTH, (head[1] + dy) % HEIGHT)

    # Krock med sig sj√§lv eller spelaren ‚Üí omstart
    if new_head in enemy_snake or new_head in player_snake:
        enemy_snake[:] = [(300, 200)]
        enemy_length = 1
        return

    enemy_snake.insert(0, new_head)

    for f in foods[:]:
        if (f[0], f[1]) == new_head and f[2] == "red":
            enemy_length += 1
            foods.remove(f)
            foods.append((random.randrange(0, WIDTH, CELL), random.randrange(0, HEIGHT, CELL), "red"))
            return

    if len(enemy_snake) > enemy_length:
        enemy_snake.pop()

        
def get_valid_enemy_move(head):
    directions = [(CELL, 0), (-CELL, 0), (0, CELL), (0, -CELL)]
    random.shuffle(directions)  # s√• den inte fastnar i ett m√∂nster

    def is_safe(pos):
        return pos not in enemy_snake and pos not in player_snake

    target = next(((fx, fy) for fx, fy, kind in foods if kind == "red"), None)

    # Prioritera drag som n√§rmar sig m√•l
    if target:
        directions.sort(key=lambda d: abs((head[0] + d[0]) % WIDTH - target[0]) + abs((head[1] + d[1]) % HEIGHT - target[1]))

    for dx, dy in directions:
        new_pos = ((head[0] + dx) % WIDTH, (head[1] + dy) % HEIGHT)
        if is_safe(new_pos):
            return dx, dy

    # Inga s√§kra drag ‚Üí g√• √§nd√• (kommer leda till d√∂d och omstart)
    return directions[0]
        
        

def key_handler(e):
    global direction
    key = e.key
    if game_state != "playing":
        return
    if key == "ArrowUp" and direction[1] == 0:
        direction = (0, -CELL)
    elif key == "ArrowDown" and direction[1] == 0:
        direction = (0, CELL)
    elif key == "ArrowLeft" and direction[0] == 0:
        direction = (-CELL, 0)
    elif key == "ArrowRight" and direction[0] == 0:
        direction = (CELL, 0)

def start_game(evt=None):
    global game_state, game_loop_running
    game_state = "playing"
    game_loop_running = False
    reset_game()
    document.getElementById("startScreen").style.display = "none"

    # Ladda ljud s√• de spelas s√§kert senare (s√§rskilt i Safari)
    for id in ["soundFood", "soundDeath", "bgMusic"]:
        el = document.getElementById(id)
        if el:
            el.load()

    asyncio.ensure_future(game_loop())

def reset_game():
    global player_snake, player_length, player_score, enemy_snake, enemy_length, direction, foods, counter
    player_snake[:] = [(WIDTH // 2, HEIGHT // 2)]
    player_length = 5
    player_score = 0
    enemy_snake[:] = [(300, 200)]
    enemy_length = 1
    direction = (CELL, 0)
    foods[:] = [(random.randrange(0, WIDTH, CELL), random.randrange(0, HEIGHT, CELL), "red") for _ in range(2)]
    counter = 0

async def update_start_toplist():
    global highscores
    try:
        hs = await get_highscores()
        highscores = hs
        html = "<h3>Global Topplista:</h3>"
        for entry in hs:
            html += f"<p>{entry['name']}: {entry['score']}</p>"
        document.getElementById("topList").innerHTML = html
    except Exception as e:
        document.getElementById("topList").innerHTML = f"<p>Fel: {e}</p>"

# Event-bindningar
key_proxy = create_proxy(key_handler)
document.addEventListener("keydown", key_proxy)
asyncio.ensure_future(update_start_toplist())
  </py-script>
  
  <!-- JavaScript f√∂r mobilv√§nlig styrning -->
  <script>
    function setDirection(dir) {
      let code = `
from js import window
if game_state == "playing":
    global direction
    if "${dir}" == "up" and direction[1] == 0:
        direction = (0, -CELL)
    elif "${dir}" == "down" and direction[1] == 0:
        direction = (0, CELL)
    elif "${dir}" == "left" and direction[0] == 0:
        direction = (-CELL, 0)
    elif "${dir}" == "right" and direction[0] == 0:
        direction = (CELL, 0)
`;
      pyodide.runPython(code);
    }
    

 async function startWithMusic() {
    const music = document.getElementById("bgMusic");
    if (music && music.paused) {
      try {
        await music.play();
      } catch (e) {
        console.log("üéµ Musikblockerad:", e);
      }
    }

    // V√§nta p√• Pyodide via PyScript:s inbyggda promise
    if (typeof pyodideReadyPromise !== "undefined") {
      await pyodideReadyPromise;
    }

    await pyodide.runPythonAsync("start_game()");
  }

  </script>
</body>
</html>
